# üí∞ Portal de Controle Financeiro Pessoal

Sistema web para controle financeiro pessoal com login e senha, onde o usu√°rio pode registrar receitas, despesas e visualizar o total l√≠quido.

---
## üõ†Ô∏è Tecnologias Utilizadas

| üñ•Ô∏è Frontend  | ‚öôÔ∏è Backend     | üì¶ Pacotes Node.js                        |
|--------------|----------------|-------------------------------------------|
| HTML5        | Node.js        | **Servidor & Roteamento:**               |
| CSS3         | Express        | ‚Ä¢ express                                 |
| JavaScript   | PostgreSQL     |                                           |
|              |                | **Banco de Dados:**                      |
|              |                | ‚Ä¢ pg                                      |
|              |                |                                           |
|              |                | **Autentica√ß√£o & Sess√µes:**             |
|              |                | ‚Ä¢ bcryptjs                                |
|              |                | ‚Ä¢ jsonwebtoken                            |
|              |                | ‚Ä¢ passport                                |
|              |                | ‚Ä¢ passport-google-oauth20                |
|              |                | ‚Ä¢ express-session                         |
|              |                |                                           |
|              |                | **Middlewares & Utilit√°rios:**          |
|              |                | ‚Ä¢ body-parser                             |
|              |                | ‚Ä¢ cookie-parser                           |
|              |                | ‚Ä¢ cors *(opcional)*                       |
|              |                | ‚Ä¢ dotenv                                  |
|              |                | ‚Ä¢ morgan *(logger)*                       |
|              |                |                                           |
|              |                | **Template Engine:**                    |
|              |                | ‚Ä¢ pug                                     |

---

## üìö Legenda dos Pacotes Node.js

### üîß Servidor & Roteamento
- **express**: Framework para rotas e servidor web.

### üóÉÔ∏è Banco de Dados
- **pg**: Cliente PostgreSQL para Node.js.

### üîê Autentica√ß√£o & Sess√µes
- **bcryptjs**: Criptografia de senhas.
- **jsonwebtoken**: Gera√ß√£o/valida√ß√£o de tokens JWT.
- **passport**: Middleware de autentica√ß√£o.
- **passport-google-oauth20**: Login com conta Google.
- **express-session**: Gerenciamento de sess√µes com cookies.

### ‚öôÔ∏è Middlewares & Utilit√°rios
- **body-parser**: Parser de JSON e formul√°rios.
- **cookie-parser**: Leitura de cookies.
- **cors**: Habilita CORS.
- **dotenv**: Gerencia vari√°veis de ambiente.
- **morgan**: Log das requisi√ß√µes.

### üé® Template Engine
- **pug**: Motor de template para renderizar HTML din√¢mico.

---


# üì• Instala√ß√£o:

### 1. Clone o reposit√≥rio:
```bash
git clone https://github.com/CaioRodrigoCEVDEV/MyAPI.git
```
### 2. Instala√ß√£o dos pacotes Node.js

```bash
npm init -y
npm install express pg bcryptjs jsonwebtoken body-parser dotenv cors cookie-parser pug morgan passport passport-google-oauth20 express-session
```
### 3. Crie um arquivo .env na raiz com o seguinte conte√∫do:

```bash
DB_HOST=SEU_IP
DB_PORT=PORTA
DB_USER=USUARIO
DB_PASSWORD=SENHA
DB_NAME=BASE_DADOS
BASE_URL=http://localhost:3000
GOOGLE_CLIENT_ID=API_key
GOOGLE_CLIENT_SECRET=API_key
HTTPS=false

```
---
# üì¶ Estrutura do Banco de Dados

Este reposit√≥rio cont√©m a defini√ß√£o de um banco de dados PostgreSQL com tr√™s tabelas principais: `usu`, `tc` e `doc`, al√©m de uma `SEQUENCE` utilizada para gera√ß√£o autom√°tica de IDs na tabela `doc`.

---

## üîê Tabela `usu` (Usu√°rios)

Armazena os dados de login dos usu√°rios do sistema.

```sql
CREATE TABLE public.usu (
	usucod serial4 NOT NULL,
  usunome varchar NULL,
	usuemail varchar(120) NOT NULL,
	ususenha varchar(32) NULL,
	CONSTRAINT pk_usu PRIMARY KEY (usucod, usuemail)
);

-- Permissions

ALTER TABLE public.usu OWNER TO postgres;
GRANT ALL ON TABLE public.usu TO postgres;
```
- **usucod**  : C√≥digo do usuario.
- **usunome**  : Nome do usuario.
- **usuemail**: E-mail do usu√°rio (chave prim√°ria).
- **ususenha**: Senha do usu√°rio (armazenada como hash MD5, por exemplo).

### üë§ Inser√ß√£o de exemplo:
```sql
INSERT INTO usu (usunome,usuemail,ususenha)VALUES ('usuario','email@email.com', md5('123'));
```

### üîê Permiss√µes:
- Dono: `postgres`
- Permiss√µes completas: `postgres`
- Permiss√£o de leitura: `consulta`

---

## üí≥ Tabela `tc` (Tipos de Cobran√ßa)

Tabela com os tipos de cobran√ßa dispon√≠veis no sistema.

```sql
CREATE TABLE public.tc (
	tcusucod int4 NULL,
	tccod serial4 NOT NULL,
	tcdes varchar(40) NOT NULL,
	tctipo varchar(40) NULL,
	CONSTRAINT tc_pkey PRIMARY KEY (tccod)
);

-- Permissions

ALTER TABLE public.tc OWNER TO postgres;
GRANT ALL ON TABLE public.tc TO postgres;
```

- **tcusucod**: C√≥digo do usu√°rio.
- **tccod**: C√≥digo do tipo de cobran√ßa (chave prim√°ria).
- **tcdes**: Descri√ß√£o (ex: "DINHEIRO").
- **tctipo**: Tipo da cobran√ßa (ex: "DH").

### ‚ûï Inser√ß√£o de exemplo:
```sql
INSERT INTO tc(tccod, tcdes, tctipo) VALUES (1, 'DINHEIRO', 'DH');
```

### üîê Permiss√µes:
- Dono: `postgres`
- Permiss√µes completas: `postgres`
- Permiss√£o de leitura: `consulta`

---


## üí≥ Tabela `contatipo` (Tipos da conta)

Tabela com os tipos da conta dispon√≠veis no sistema.

```sql
create table public.contatipo (
	contatipocod serial,
	contatipodes varchar,
	CONSTRAINT pk_contatipo PRIMARY KEY (contatipocod)
);

```

- **contatipocod**: C√≥digo do tipo da conta (chave prim√°ria).
- **contatipodes**: Descri√ß√£o (ex: "DINHEIRO","CONTA CORRENTE","INVESTIMENTOS").



### ‚ûï Inser√ß√£o OBRIGAT√ìRIA:
```sql
insert into contatipo (contatipodes) values ('Dinheiro');
insert into contatipo (contatipodes) values ('Conta Corrente');
insert into contatipo (contatipodes) values ('Conta Poupan√ßa');
insert into contatipo (contatipodes) values ('Investimento');
insert into contatipo (contatipodes) values ('Outro');
```

### üîê Permiss√µes:
- Dono: `postgres`
- Permiss√µes completas: `postgres`
- Permiss√£o de leitura: `consulta`

---

## üí≥ Tabela `conta` (Contas)

Tabela com as contas dispon√≠veis no sistema.

```sql
create table public.conta (
  contausucod int NOT NULL,
	contacod serial,
	contades varchar,
	contatipo int,
	contavltotal numeric(14, 2),
	CONSTRAINT pk_conta PRIMARY KEY (contacod),
	CONSTRAINT fk_contatipo FOREIGN KEY (contatipo) REFERENCES public.contatipo(contatipocod)
);
```
- **contausucod**: C√≥digo do usu√°rio.
- **contacod**: C√≥digo da conta (chave prim√°ria).
- **contades**: Descri√ß√£o (ex: "CAIXA","CARTEIRA","BANCO INTER").
- **contatipo**: Tipo da conta (ex: "1","2","3","4" ou "5").
- **contavltotal**: Saldo total da conta (ex: "36000.00").


### üîê Permiss√µes:
- Dono: `postgres`
- Permiss√µes completas: `postgres`
- Permiss√£o de leitura: `consulta`

---

## üìÑ Tabela `doc` (Documentos)

Registra documentos de cobran√ßa, com associa√ß√£o ao tipo de cobran√ßa.

```sql
CREATE TABLE public.doc (
  docusucod int4 NOT NULL,
  doccod serial NOT NULL,
  docnatcod int NULL,
  docsta bpchar(2) NULL,
  docdtlan timestamp NULL,
  docdtpag date,
  docv numeric(14, 2) DEFAULT 0 NOT NULL,
  doctccod int4 NULL,
  docnum varchar(18) NULL,
  docobs bpchar(254) NULL,
  doccontacod int,
  doccatcod int,
  CONSTRAINT pk_doc PRIMARY KEY (doccod,docusucod),
  CONSTRAINT fk_doc_tc FOREIGN KEY (doctccod) REFERENCES public.tc(tccod),
  CONSTRAINT fk_doc FOREIGN KEY (doccontacod) REFERENCES conta(contacod)
);
```

- **docusucod**: C√≥digo da usu√°rio.
- **doccod**: C√≥digo do documento (gerado automaticamente pela sequence).
- **doctipo**: Tipo do documento.
- **docsta**: Status.
- **docdtlan**: Data de lan√ßamento.
- **docdtpag**: Data de pagamento.
- **docv**: Valor do documento.
- **doctccod**: C√≥digo do tipo de cobran√ßa (chave estrangeira para `tc`).
- **docnum**: N√∫mero do documento.
- **docobs**: Observa√ß√µes.
- **doccontacod**: C√≥digo da conta.
- **doccatcod**: C√≥digo da categoria.

### ‚ûï Inser√ß√£o de exemplo:
```sql
INSERT INTO doc (docempparcod, docv, doctccod) VALUES (1, 100.00, 1);
```

### üîê Permiss√µes:
- Dono: `postgres`
- Permiss√µes completas: `postgres`
- Permiss√£o de leitura: `consulta`

---

## üí≥ Tabela `categoria` (Categorias)

Tabela com as Categorias dispon√≠veis no sistema.

```sql
create table public.categoria (
  catusucod int,
	catcod serial,
	catdes varchar,
	cattipo character,
  catnatcod int,
	CONSTRAINT pk_cat PRIMARY KEY (catcod,cattipo)
);
```

- **catusucod**: C√≥digo do usu√°rio.
- **catcod**: C√≥digo da categoria (chave prim√°ria).
- **catdes**: Descri√ß√£o (ex: "Transporte","Salario","Mercado").
- **cattipo**: Status da categoria R ou D (ex: "Receita" ou "Despesa").

### ‚ûï Inser√ß√£o de exemplo:
```sql
insert into categoria (catusucod,catdes,cattipo) values (1,'Sal√°rio','R');
insert into categoria (catusucod,catdes,cattipo) values (1,'Transporte','D');
insert into categoria (catusucod, catdes,cattipo) values (1,'Mercado','D');
insert into categoria (catusucod,catdes,cattipo) values (1,'Frelancer','R');
```


### üîê Permiss√µes:
- Dono: `postgres`
- Permiss√µes completas: `postgres`
- Permiss√£o de leitura: `consulta`

---

## üí≥ Tabela `natureza` (Natureza)

Tabela com as Naturezas dispon√≠veis no sistema.

```sql
create table public.natureza (
	natcod serial,
	natdes varchar,
	CONSTRAINT pk_nat PRIMARY KEY (natcod,natdes)
);
```

- **natcod**: C√≥digo da natureza (chave prim√°ria).
- **natdes**: Descri√ß√£o (ex: "Receita","Despesa").

### ‚ûï Inser√ß√£o OBRIGAT√ìRIA:
```sql
insert into natureza (natdes) values('Despesa');
insert into natureza (natdes) values('Receita');

```


### üîê Permiss√µes:
- Dono: `postgres`
- Permiss√µes completas: `postgres`
- Permiss√£o de leitura: `consulta`

---

## üí≥ Tabela `cartaocredito` (Cart√µes de Cr√©dito)

Gerencia os cart√µes de cr√©dito cadastrados pelo usu√°rio.

```sql
CREATE TABLE public.cartaocredito (
  cccod serial PRIMARY KEY,
  ccusucod int,
  ccdes varchar,
  cclimite numeric(14, 2),
  ccfechamento int,
  ccvencimento int
);
```
- **cccod**: Identificador do cart√£o (chave prim√°ria).
- **ccusucod**: C√≥digo do usu√°rio dono do cart√£o.
- **ccdes**: Descri√ß√£o do cart√£o.
- **cclimite**: Limite de cr√©dito dispon√≠vel.
- **ccfechamento**: Dia de fechamento da fatura (1-31).
- **ccvencimento**: Dia de vencimento da fatura (1-31).

## üí≥ Tabela `gastocredito` (Gastos do Cart√£o)

Registra as compras realizadas no cart√£o de cr√©dito.

```sql
CREATE TABLE public.gastocredito (
  gcid serial PRIMARY KEY,
  ccid int,
  catcod int,
  descricao varchar,
  valor numeric(14, 2),
  data date,
  mesfat varchar(7),
  usucod int
);
```
- **gcid**: C√≥digo do gasto (chave prim√°ria).
- **ccid**: C√≥digo do cart√£o relacionado.
- **catcod**: C√≥digo da categoria do gasto.
- **descricao**: Detalhe do gasto.
- **valor**: Valor da transa√ß√£o.
- **data**: Data da compra.
- **mesfat**: M√™s de faturamento no formato YYYY-MM.
- **usucod**: C√≥digo do usu√°rio.

## ‚úÖ Consultas e Testes

### Ver todos os usu√°rios:
```sql
SELECT * FROM usu;
```

### Ver tipos de cobran√ßa:
```sql
SELECT * FROM tc;
```

### Ver documentos:
```sql
SELECT * FROM doc;
```

---

## üîí Seguran√ßa

As permiss√µes foram definidas para garantir o controle de acesso:

- O usu√°rio `postgres` possui controle total.
- O papel `consulta` possui acesso apenas de leitura.

---
# üí∞ View Saldo

```sql
-- public.vw_saldo_contas fonte

CREATE OR REPLACE VIEW public.vw_saldo_contas
AS SELECT c.contausucod AS usu,
    COALESCE(sum(c.contavltotal), 0::numeric) AS contas_saldo
   FROM conta c
  GROUP BY c.contausucod;

-- Permissions

ALTER TABLE public.vw_saldo_contas OWNER TO postgres;
GRANT ALL ON TABLE public.vw_saldo_contas TO postgres;
```

---
# üí∞ View Receita VS Despesas | ANUAL

```sql
CREATE OR REPLACE VIEW public.vw_receita_vs_despesa_anual
AS SELECT doc.docusucod,
    doc.docnatcod,
    to_char(date_trunc('month'::text, doc.docdtpag::timestamp with time zone), 'YYYY-MM'::text) AS mes,
    sum(doc.docv) AS total
   FROM doc
  WHERE date_part('year'::text, doc.docdtpag) = date_part('year'::text, CURRENT_DATE)
  GROUP BY doc.docusucod, doc.docnatcod, (date_trunc('month'::text, doc.docdtpag::timestamp with time zone))
  ORDER BY doc.docusucod, doc.docnatcod, (to_char(date_trunc('month'::text, doc.docdtpag::timestamp with time zone), 'YYYY-MM'::text));

-- Permissions

ALTER TABLE public.vw_receita_vs_despesa_anual OWNER TO postgres;
GRANT ALL ON TABLE public.vw_receita_vs_despesa_anual TO postgres;
```

---

# üí∞ View Or√ßado VS Realizado | ANUAL

```sql
CREATE OR REPLACE VIEW public.vw_orcado_vs_realizado_anual
AS SELECT doc.docusucod,
    doc.docsta,
    to_char(date_trunc('month'::text, doc.docdtpag::timestamp with time zone), 'YYYY-MM'::text) AS mes,
    sum(doc.docv) AS total
   FROM doc
  WHERE date_part('year'::text, doc.docdtpag) = date_part('year'::text, CURRENT_DATE) AND doc.docnatcod = 1
  GROUP BY doc.docusucod, doc.docsta, (date_trunc('month'::text, doc.docdtpag::timestamp with time zone))
  ORDER BY doc.docusucod, doc.docsta, (to_char(date_trunc('month'::text, doc.docdtpag::timestamp with time zone), 'YYYY-MM'::text));

-- Permissions

ALTER TABLE public.vw_orcado_vs_realizado_anual OWNER TO postgres;
GRANT ALL ON TABLE public.vw_orcado_vs_realizado_anual TO postgres;
```

---

# üí∞ View Or√ßado VS Realizado | ANUAL

```sql
CREATE OR REPLACE VIEW public.vw_total_seguro
AS SELECT vw_saldo_contas.usu,
    vw_saldo_contas.contas_saldo - sum(doc.docv) AS total_seguro
   FROM vw_saldo_contas
     JOIN doc ON doc.docusucod = vw_saldo_contas.usu AND doc.docsta = 'LA'::bpchar AND doc.docnatcod = 1
  GROUP BY vw_saldo_contas.usu, vw_saldo_contas.contas_saldo;

-- Permissions

ALTER TABLE public.vw_total_seguro OWNER TO postgres;
GRANT ALL ON TABLE public.vw_total_seguro TO postgres;
```

---

## üîê Vari√°veis de Ambiente

Exemplo `.env`:

```env
DB_HOST=
DB_PORT=
DB_USER=
DB_PASSWORD=
DB_NAME=
BASE_URL=
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
HTTPS=false

```

---

## üìö Endpoints

### üîë Login

**POST** `/api/login`

**Body:**
```json
{
  "email": "user@email.com",
  "password": "123456"
}
```

**Resposta:**
```json
{
  "token": "jwt_token"
}
```

---

### üë§ Criar Usu√°rio

**POST** `/api/users`

**Body:**
```json
{
  "name": "Nome Teste",
  "email": "email@email.com",
  "password": "123456"
}
```

**Resposta:**
```json
{
  "message": "Usu√°rio criado com sucesso",
  "user": {
    "id": 1,
    "name": "Nome Teste",
    "email": "email@email.com"
  }
}
```

---

### üîí Perfil do Usu√°rio

**GET** `/api/profile`

**Headers:**
```
Authorization: Bearer <token>
```

**Resposta:**
```json
{
  "id": 1,
  "name": "Nome Teste",
  "email": "enail@email.com"
}
```

---
